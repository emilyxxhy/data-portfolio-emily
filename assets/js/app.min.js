// Vanilla JS for app.min.js

document.addEventListener('DOMContentLoaded', () => {

    // --- 1. Mobile Menu Toggle ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');

    mobileMenuBtn.addEventListener('click', () => {
        const isExpanded = mobileMenuBtn.getAttribute('aria-expanded') === 'true' || false;
        mobileMenuBtn.setAttribute('aria-expanded', !isExpanded);
        mobileMenu.classList.toggle('hidden');
    });

    // Close mobile menu on link click
    mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            mobileMenu.classList.add('hidden');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
        });
    });

    // --- 2. Typing Animation for Welcome Headline ---
    const headline = document.getElementById('welcome-headline');
    // Stronger brand statement
    const textToType = "Hi, I'm Emily! ðŸ‘‹ Data Translator. Impact Driver.";
    let i = 0;
    let speed = 75; // Typing speed in milliseconds

    function typeWriter() {
        if (i < textToType.length) {
            headline.innerHTML += textToType.charAt(i);
            i++;
            setTimeout(typeWriter, speed);
        } else {
            // Remove the blinking cursor effect after typing completes
            headline.classList.remove('border-r-4', 'border-brand-orange', 'animate-typing');
        }
    }
    
    // Check for reduced motion preference before running animation
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        setTimeout(typeWriter, 1000); // Start after 1 second delay
    } else {
        headline.textContent = textToType; // Show full text immediately
        headline.classList.remove('border-r-4', 'border-brand-orange', 'animate-typing');
    }

    // --- 3. Scroll-Based Fade-In Effect (Intersection Observer) ---
    const fadeElements = document.querySelectorAll('.fade-in');
    
    const observerOptions = {
        root: null, // viewport
        rootMargin: '0px 0px -100px 0px', // Trigger slightly before it hits the bottom
        threshold: 0.05 // 5% of element visible
    };

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target); // Stop observing once it's visible
            }
        });
    }, observerOptions);

    fadeElements.forEach(el => observer.observe(el));

    // --- 4. Active Navigation Link Highlighting & Sticky Header ---
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('main section');
    const header = document.getElementById('site-header');

    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const targetId = entry.target.id;
                // Only mark active if section is mostly visible (better for long sections)
                if (entry.intersectionRatio >= 0.25 || entry.boundingClientRect.top < window.innerHeight / 2) {
                    navLinks.forEach(link => link.classList.remove('nav-link-active'));
                    const activeLink = document.querySelector(`.nav-link[href="#${targetId}"]`);
                    if (activeLink) {
                        activeLink.classList.add('nav-link-active');
                    }
                }
            }
        });
    }, {
        root: null,
        rootMargin: '-50% 0px -50% 0px', // Center of the viewport
        threshold: 0 // Observe as soon as it crosses the center
    });

    sections.forEach(section => sectionObserver.observe(section));

    // --- 5. Back-to-Top Button Functionality ---
    const backToTopButton = document.getElementById('back-to-top');

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTopButton.classList.remove('opacity-0');
            backToTopButton.classList.add('opacity-100');
        } else {
            backToTopButton.classList.remove('opacity-100');
            backToTopButton.classList.add('opacity-0');
        }
    });

    backToTopButton.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // --- 6. Client-Side Form Validation ---
    const form = document.getElementById('contact-form');
    const formMessage = document.getElementById('form-message');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        const requiredFields = ['name', 'email', 'message'];
        
        requiredFields.forEach(id => {
            const input = document.getElementById(id);
            const error = document.getElementById(id + '-error');
            
            if (!input.value.trim()) {
                input.classList.add('border-red-500');
                error.classList.remove('hidden');
                isValid = false;
            } else {
                input.classList.remove('border-red-500');
                error.classList.add('hidden');
            }
        });

        const emailInput = document.getElementById('email');
        if (emailInput && !/\S+@\S+\.\S+/.test(emailInput.value)) {
            emailInput.classList.add('border-red-500');
            document.getElementById('email-error').textContent = 'Please enter a valid email address.';
            document.getElementById('email-error').classList.remove('hidden');
            isValid = false;
        }

        if (isValid) {
            formMessage.classList.add('hidden');
            // Form is valid, construct the mailto link
            const subject = encodeURIComponent('Inquiry from Portfolio');
            const body = encodeURIComponent(`Name: ${document.getElementById('name').value}\nEmail: ${document.getElementById('email').value}\n\nMessage:\n${document.getElementById('message').value}`);
            const mailtoLink = `mailto:emily@placeholder.com?subject=${subject}&body=${body}`;
            
            // Redirect to mailto link
            window.location.href = mailtoLink;
            
            // Show success message and reset form (for non-mailto version)
            // formMessage.textContent = 'Thank you! Your message has been prepared for sending.';
            // formMessage.classList.remove('hidden');
            // formMessage.classList.remove('bg-red-100', 'text-red-800');
            // formMessage.classList.add('bg-green-100', 'text-green-800');
            // form.reset();
        } else {
            formMessage.textContent = 'Please correct the errors in the form.';
            formMessage.classList.remove('hidden');
            formMessage.classList.remove('bg-green-100', 'text-green-800');
            formMessage.classList.add('bg-red-100', 'text-red-800');
            
            // Focus on the first error field for keyboard users
            const firstError = document.querySelector('.border-red-500');
            if (firstError) {
                firstError.focus();
            }
        }
    });
});